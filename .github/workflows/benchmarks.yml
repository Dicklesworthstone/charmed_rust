name: Benchmarks

on:
  push:
    branches: [main, master]
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

env:
  CARGO_TERM_COLOR: always

jobs:
  benchmark:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@nightly

      - name: Cache cargo registry and build
        uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
        with:
          cache-on-failure: true
          key: benchmarks-${{ runner.os }}-${{ runner.arch }}-${{ hashFiles('**/Cargo.lock') }}

      - name: Run benchmarks
        run: |
          cargo bench --workspace --no-run
          cargo bench --workspace -- --noplot --save-baseline pr

      - name: Download baseline (for PRs)
        if: github.event_name == 'pull_request'
        uses: dawidd6/action-download-artifact@80620a5d27ce0ae443b965134f7a0dc3cce81bd8 # v3.1.2
        with:
          workflow: benchmarks.yml
          branch: ${{ github.base_ref }}
          name: criterion-baseline
          path: target/criterion-baseline
        continue-on-error: true

      - name: Compare against baseline (for PRs)
        if: github.event_name == 'pull_request'
        id: compare
        run: |
          # Check if baseline exists
          if [ -d "target/criterion-baseline" ]; then
            echo "Baseline found, comparing..."

            # Copy baseline into criterion directory for comparison
            mkdir -p target/criterion
            cp -r target/criterion-baseline/* target/criterion/ 2>/dev/null || true

            # Run comparison benchmarks
            cargo bench --workspace -- --noplot --baseline main 2>&1 | tee benchmark-results.txt

            # Parse results for regressions
            WARNINGS=$(grep -c "Performance has regressed" benchmark-results.txt || echo "0")
            CRITICAL=$(grep -E -c "change: \\+[2-9][0-9]\\.[0-9]+%|\\+[1-9][0-9]{2,}\\.[0-9]+%" benchmark-results.txt || echo "0")

            echo "warnings=$WARNINGS" >> "$GITHUB_OUTPUT"
            echo "critical=$CRITICAL" >> "$GITHUB_OUTPUT"

            # Create summary
            {
              echo "## Benchmark Comparison Results"
              echo ""
              echo "### Summary"
              if [ "$WARNINGS" -gt 0 ]; then
                echo "- :warning: **$WARNINGS** benchmark(s) show performance regression"
              else
                echo "- :white_check_mark: No significant regressions detected"
              fi
              if [ "$CRITICAL" -gt 0 ]; then
                echo "- :x: **$CRITICAL** benchmark(s) regressed more than 20%"
              fi
              echo ""
              echo "<details>"
              echo "<summary>Full Benchmark Results</summary>"
              echo ""
              echo '```'
              cat benchmark-results.txt
              echo '```'
              echo "</details>"
            } > benchmark-summary.md
          else
            echo "No baseline found - this is the first benchmark run"
            echo "warnings=0" >> "$GITHUB_OUTPUT"
            echo "critical=0" >> "$GITHUB_OUTPUT"
            {
              echo "## Benchmark Results"
              echo ""
              echo ":information_source: No baseline available for comparison. Benchmarks will be compared on future PRs."
              echo ""
              echo "<details>"
              echo "<summary>Current Benchmark Results</summary>"
              echo ""
              echo '```'
              cargo bench --workspace -- --noplot 2>&1 | head -200
              echo '```'
              echo "</details>"
            } > benchmark-summary.md
          fi

      - name: Comment on PR
        if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('benchmark-summary.md', 'utf8');

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Benchmark Comparison Results') || comment.body.includes('Benchmark Results')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: summary
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: summary
              });
            }

      - name: Check for critical regressions
        if: github.event_name == 'pull_request'
        run: |
          CRITICAL="${{ steps.compare.outputs.critical }}"
          if [ "$CRITICAL" -gt 0 ]; then
            echo "::error::Critical performance regression detected: $CRITICAL benchmark(s) regressed more than 20%"
            exit 1
          fi

          WARNINGS="${{ steps.compare.outputs.warnings }}"
          if [ "$WARNINGS" -gt 0 ]; then
            echo "::warning::Performance regression detected: $WARNINGS benchmark(s) show regression"
          fi

      - name: Save baseline (on push to main)
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        run: |
          # Run benchmarks and save as baseline
          cargo bench --workspace -- --noplot --save-baseline main

          # Copy criterion data for artifact
          mkdir -p criterion-baseline
          cp -r target/criterion/* criterion-baseline/ 2>/dev/null || true

      - name: Upload baseline artifact
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: criterion-baseline
          path: criterion-baseline/
          retention-days: 30
          if-no-files-found: warn
