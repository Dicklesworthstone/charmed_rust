name: WASM Build

on:
  push:
    branches: [main, master]
    paths:
      - 'crates/lipgloss/**'
      - 'crates/charmed-wasm/**'
      - 'scripts/build-wasm.sh'
      - '.github/workflows/wasm.yml'
  pull_request:
    paths:
      - 'crates/lipgloss/**'
      - 'crates/charmed-wasm/**'
      - 'scripts/build-wasm.sh'
      - '.github/workflows/wasm.yml'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: -D warnings

jobs:
  build-wasm:
    name: Build WASM
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@nightly
        with:
          targets: wasm32-unknown-unknown

      - name: Cache cargo registry and build
        uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
        with:
          key: wasm-${{ hashFiles('**/Cargo.lock') }}

      - name: Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

      - name: Check lipgloss WASM compilation
        run: cargo check -p lipgloss --no-default-features --features wasm --target wasm32-unknown-unknown

      - name: Check charmed-wasm compilation
        run: cargo check -p charmed-wasm --target wasm32-unknown-unknown

      - name: Build WASM packages
        run: ./scripts/build-wasm.sh

      - name: Verify package structure
        run: |
          # Check that key files exist in each package
          for target in bundler web nodejs; do
            echo "Checking $target package..."
            ls -la pkg/$target/
            test -f pkg/$target/charmed_wasm_bg.wasm || (echo "Missing .wasm file in $target" && exit 1)
            test -f pkg/$target/charmed_wasm.js || (echo "Missing .js file in $target" && exit 1)
          done

      - name: Report package sizes
        run: |
          echo "## WASM Package Sizes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Target | WASM Size | Gzipped |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-----------|---------|" >> $GITHUB_STEP_SUMMARY
          for target in bundler web nodejs; do
            wasm_file=$(find pkg/$target -name "*.wasm" -type f | head -1)
            if [ -n "$wasm_file" ]; then
              size=$(du -h "$wasm_file" | cut -f1)
              gzip_size=$(gzip -c "$wasm_file" | wc -c | awk '{printf "%.1fK", $1/1024}')
              echo "| $target | $size | $gzip_size |" >> $GITHUB_STEP_SUMMARY
            fi
          done

      - name: Upload WASM artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: wasm-packages
          path: pkg/
          retention-days: 7

  test-wasm:
    name: Test WASM
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: build-wasm
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@nightly
        with:
          targets: wasm32-unknown-unknown

      - name: Cache cargo registry and build
        uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
        with:
          key: wasm-test-${{ hashFiles('**/Cargo.lock') }}

      - name: Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

      - name: Run WASM tests (headless Chrome)
        run: wasm-pack test --headless --chrome crates/charmed-wasm
        continue-on-error: true  # Tests may not exist yet

      - name: Run WASM tests (headless Firefox)
        run: wasm-pack test --headless --firefox crates/charmed-wasm
        continue-on-error: true  # Tests may not exist yet

  # Publish to npm (only on tags)
  publish-npm:
    name: Publish to npm
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [build-wasm, test-wasm]
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: wasm-packages
          path: pkg/

      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Publish bundler package to npm
        working-directory: pkg/bundler
        run: npm publish --access public --provenance
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        continue-on-error: true  # May fail if version exists
