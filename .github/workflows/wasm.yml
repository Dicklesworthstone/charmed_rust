name: WASM Build

on:
  push:
    branches: [main, master]
    paths:
      - 'crates/lipgloss/**'
      - 'crates/charmed-wasm/**'
      - 'scripts/build-wasm.sh'
      - '.github/workflows/wasm.yml'
  pull_request:
    paths:
      - 'crates/lipgloss/**'
      - 'crates/charmed-wasm/**'
      - 'scripts/build-wasm.sh'
      - '.github/workflows/wasm.yml'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: -D warnings

jobs:
  build-wasm:
    name: Build WASM
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@nightly
        with:
          targets: wasm32-unknown-unknown

      - name: Cache cargo registry and build
        uses: Swatinem/rust-cache@9d47c6ad4b02e050fd481d890b2ea34778fd09d6 # v2.7.8
        with:
          key: wasm-${{ hashFiles('**/Cargo.lock') }}

      - name: Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

      - name: Check lipgloss WASM compilation
        run: cargo check -p lipgloss --no-default-features --features wasm --target wasm32-unknown-unknown

      - name: Check charmed-wasm compilation
        run: cargo check -p charmed-wasm --target wasm32-unknown-unknown

      - name: Build WASM packages
        run: ./scripts/build-wasm.sh

      - name: Verify package structure
        run: |
          # Check that key files exist in each package
          for target in bundler web nodejs; do
            echo "Checking $target package..."
            ls -la pkg/$target/
            test -f pkg/$target/charmed_wasm_bg.wasm || (echo "Missing .wasm file in $target" && exit 1)
            test -f pkg/$target/charmed_wasm.js || (echo "Missing .js file in $target" && exit 1)
          done

      - name: Report package sizes
        run: |
          echo "## WASM Package Sizes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Target | WASM Size | Gzipped |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-----------|---------|" >> $GITHUB_STEP_SUMMARY
          for target in bundler web nodejs; do
            wasm_file=$(find pkg/$target -name "*.wasm" -type f | head -1)
            if [ -n "$wasm_file" ]; then
              size=$(du -h "$wasm_file" | cut -f1)
              gzip_size=$(gzip -c "$wasm_file" | wc -c | awk '{printf "%.1fK", $1/1024}')
              echo "| $target | $size | $gzip_size |" >> $GITHUB_STEP_SUMMARY
            fi
          done

      - name: Upload WASM artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: wasm-packages
          path: pkg/
          retention-days: 7

  test-wasm:
    name: Test WASM
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: build-wasm
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@nightly
        with:
          targets: wasm32-unknown-unknown

      - name: Cache cargo registry and build
        uses: Swatinem/rust-cache@9d47c6ad4b02e050fd481d890b2ea34778fd09d6 # v2.7.8
        with:
          key: wasm-test-${{ hashFiles('**/Cargo.lock') }}

      - name: Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

      - name: Run WASM tests (headless Chrome)
        run: wasm-pack test --headless --chrome crates/charmed-wasm
        continue-on-error: true  # Tests may not exist yet

      - name: Run WASM tests (headless Firefox)
        run: wasm-pack test --headless --firefox crates/charmed-wasm
        continue-on-error: true  # Tests may not exist yet

  # Publish to npm (only on tags)
  publish-npm:
    name: Publish to npm
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [build-wasm, test-wasm]
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: wasm-packages
          path: pkg/

      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Publish bundler package to npm
        working-directory: pkg/bundler
        run: npm publish --access public --provenance
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        continue-on-error: true  # May fail if version exists
